---
- name: Report IOS version to infrahub
  gather_facts: no
  hosts: infrahub
  connection: local
  become: false
  roles:
    - ansible-pyats
  vars:
    server: "http://192.168.0.237:8000"
    endpoint1: "/api/dcim/devices/?limit=1000"
    infrahub_token: "7435d9eb9841dc8a941417a0993fc531c3dc35ca"
    upgrade_ios_version: "17.10.01a"
    ansible_connection: network_cli
    ansible_network_os: ios
    ansible_user: "{{ device_username }}"
    ansible_password: "{{ device_password }}"
    new_ios_bin: "c1100-universalk9.17.10.01a.SPA.bin"
  tasks:
    - name: Get Device List from Infrahub (GraphQL)
      uri:
        url: "{{ server }}/graphql"
        headers:
          Authorization: "Token {{ infrahub_token }}"
          Content-Type: "application/json"
        body: |
          {"query":"{ DcimDevice(limit:1000, offset:0){ edges { node { id name { value } role { label } status { value } } } } }"}
        body_format: json
        method: POST
        status_code: [200, 201]
        timeout: 60
        validate_certs: false
        return_content: yes
      register: infrahub_devices
      run_once: yes

    - name: Extract nodes from GraphQL response
      set_fact:
        devices_raw: "{{ infrahub_devices.json.data.DcimDevice.edges | map(attribute='node') | list }}"

    - name: Build filtered device list (only Cisco devices, status active, exclude IP hostnames)
      vars:
        ip_regex: '^\\d{1,3}(?:\\.\\d{1,3}){3}$'
      set_fact:
        device_name_list: "{{ device_name_list | default([]) + [ { 'Name': item.name.value|default(''), 'IP': (item.primary_address.address.value|default('')) , 'id': item.id, 'role_label': item.role.label|default(''), 'status': item.status.value|default('') } ] }}"
      loop: "{{ devices_raw }}"
      when: "(item.role is defined and item.role.label is defined and ('cisco' in (item.role.label | lower))) and (item.status is defined and item.status.value == 'active') and (item.name is defined and item.name.value is defined) and (item.name.value is not match(ip_regex))"

    - name: Expose device list for downstream tasks (device_name.msg)
      set_fact:
        device_name: "{{ {'msg': device_name_list | default([])} }}"
    - name: Normalize device list to a simple variable
      set_fact:
        device_list: "{{ device_name.msg | default([]) }}"

    - name: Skip legacy ios_facts (incompatible) â€” using ios_command instead
      ansible.builtin.debug:
        msg: "Skipping ios_facts for {{ item.Name }}; collecting via ios_command"
      loop: "{{ device_list }}"
      loop_control:
        label: "{{ item.Name }}"

    - name: Debug device facts results
      ansible.builtin.debug:
        var: device_facts_results

    - name: Run 'show version' on each device
      cisco.ios.ios_command:
        commands:
          - show version
      loop: "{{ device_list }}"
      loop_control:
        label: "{{ item.Name }}"
      vars:
        provider:
          host: "{{ item.Name }}"
          username: "{{ device_username }}"
          password: "{{ device_password }}"
      register: show_version

    - name: Debug previous command registered values
      ansible.builtin.debug:
        var: show_version

    - name: Get fact for the current IOSXE version with PyATS
      set_fact:
        current_xe_ver: "{{ item.ansible_facts.current_xe_ver }}"
      loop: "{{ show_version.results | default([]) }}"
      loop_control:
        label: "{{ loop.index0 }}"
      vars:
        # parse stdout with pyats_parser and attach to ansible_facts for consistency
        _parsed: "{{ item.stdout[0] | default('') | pyats_parser('show version', 'iosxe') }}"
      when: item.stdout is defined and item.stdout | length > 0
      register: device_iosxe_version

    - name: Debug parsed IOSXE versions
      ansible.builtin.debug:
        var: device_iosxe_version

    - name: Build filtered_info list for report
      set_fact:
        filtered_info_iosxe_version: "{{ filtered_info_iosxe_version | default([]) + [ { 'device': (device_list[item_index].Name if device_list[item_index] is defined else 'unknown'), 'parsed': device_iosxe_version.results[item_index].ansible_facts.current_xe_ver if (device_iosxe_version.results[item_index] is defined and device_iosxe_version.results[item_index].ansible_facts is defined) else {} } ] }}"
      loop: "{{ range(0, (device_iosxe_version.results | length) ) | list }}"
      loop_control:
        index_var: item_index

    # Copy

    - name: Ensure output directory exists on controller
      file:
        path: /Users/jeremierouzet/jeysible/infrahub_dynamic_inventory/inventory_output/cisco/common/report_ios_version
        state: directory
        mode: '0755'
      run_once: yes
      delegate_to: localhost

    - local_action:
        module: copy
        content: "{{ filtered_info_iosxe_version | to_nice_yaml }}"
        dest: /Users/jeremierouzet/jeysible/infrahub_dynamic_inventory/inventory_output/cisco/common/report_ios_version/report_ios_version_device_name.yml

    - local_action:
        module: copy
        content: "{{ filtered_info_iosxe_version | to_nice_json }}"
        dest: /Users/jeremierouzet/jeysible/infrahub_dynamic_inventory/inventory_output/cisco/common/report_ios_version/report_ios_version_device_name.json
