---
- name: Report IOS version to infrahub
  gather_facts: no
  hosts: infrahub
  connection: local
  become: false
  roles:
    - ansible-pyats
  vars:
    server: "http://192.168.0.237:8000"
    endpoint1: "/api/dcim/devices/?limit=1000"
    infrahub_token: "{{ lookup('env','INFRAHUB_TOKEN') | default(infrahub_api_tokens.api_token, true) }}"
    upgrade_ios_version: "17.10.01a"
    ansible_connection: network_cli
    ansible_network_os: ios
    new_ios_bin: "c1100-universalk9.17.10.01a.SPA.bin"
  tasks:
    - name: Get Device List from Infrahub (GraphQL)
      uri:
        url: "{{ server }}/graphql"
        headers:
          Authorization: "Token {{ infrahub_token }}"
          Content-Type: "application/json"
        body: |
          {"query":"{ DcimDevice(limit:1000, offset:0){ edges { node { id name { value } role { label } status { value } } } } }"}
        body_format: json
        method: POST
        status_code: [200, 201]
        timeout: 60
        validate_certs: false
        return_content: yes
      register: infrahub_devices
      run_once: yes

    - name: Extract nodes from GraphQL response
      set_fact:
        devices_raw: "{{ infrahub_devices.json.data.DcimDevice.edges | map(attribute='node') | list }}"

    - name: Build filtered device list (only Cisco manufacturer, status active, exclude IP hostnames and local names)
      vars:
        ip_regex: '^\\d{1,3}(?:\\.\\d{1,3}){3}$'
      set_fact:
        device_name_list: "{{ device_name_list | default([]) + [ { 'Name': item.name.value|default(''), 'IP': '', 'id': item.id, 'role_label': item.role.label|default(''), 'status': item.status.value|default(''), 'manufacturer': '' } ] }}"
      loop: "{{ devices_raw }}"
      when: "(item.role is defined and item.role.label is defined and ('cisco' in (item.role.label | lower)) and (item.status is defined and item.status.value == 'active') and (item.name is defined and item.name.value is defined) and (item.name.value is not match(ip_regex)) and (item.name.value | lower) not in ['localhost','infrahub'])"

    - name: Expose device list for downstream tasks (device_name.msg)
      set_fact:
        device_name: "{{ {'msg': device_name_list | default([])} }}"
    - name: Normalize device list to a simple variable
      set_fact:
        device_list: "{{ device_name.msg | default([]) }}"

    - name: Load vaulted infrahub credentials for device access
      include_vars:
        file: "{{ playbook_dir }}/../../../../group_vars/all/infrahub_vault.yml"
      run_once: true
      delegate_to: localhost

    - name: Skip legacy ios_facts (incompatible) â€” using ios_command instead
      ansible.builtin.debug:
        msg: "Skipping ios_facts for {{ item.Name }}; collecting via ios_command"
      loop: "{{ device_list }}"
      loop_control:
        label: "{{ item.Name }}"

    - name: Compute `target_host` for each device (prefer IP, else Name)
      set_fact:
        device_list2: "{{ device_list2 | default([]) + [ item | combine({'target_host': (((item.IP|default('')|trim)|length > 0) and item.IP or item.Name) }) ] }}"
      loop: "{{ device_list }}"

    - name: Debug computed device targets
      ansible.builtin.debug:
        var: device_list2

    - name: Filter to single target when `only_target` is provided
      set_fact:
        device_list2: "{{ device_list2 | selectattr('target_host','equalto', only_target) | list }}"
      when: only_target is defined

    - name: Add devices to in-memory inventory (set connection vars)
      add_host:
        name: "{{ item.target_host }}"
        groups: collected_cisco
        ansible_host: "{{ item.target_host }}"
        # use ssh for Catalyst 1200 (Linux), otherwise network_cli for network devices
        ansible_connection: "{{ 'ssh' if (item.target_host | regex_search('(?i)1200')) else 'network_cli' }}"
        ansible_network_os: "{{ 'ios' if not (item.target_host | regex_search('(?i)1200')) else omit }}"
        # use libssh transport for CBS220 and 1200
        ansible_ssh_type: "{{ 'libssh' if (item.target_host | regex_search('(?i)(1200|cbs220)')) else omit }}"
        ansible_user: "{{ (item.device_username | default(hostvars['localhost'].infrahub_api_tokens.device_username)) }}"
        ansible_password: "{{ (item.device_password | default(hostvars['localhost'].infrahub_api_tokens.device_password)) }}"
      loop: "{{ device_list2 }}"
      loop_control:
        label: "{{ item.Name }}"

- name: Run show version on collected Cisco devices
  hosts: collected_cisco
  gather_facts: false
  connection: network_cli
  tasks:
    - name: Run show version via network module (cisco.ios.ios_command)
      cisco.ios.ios_command:
        commands:
          - terminal length 0
          - show version
      register: show_version

    - name: Save show_version stdout to file on controller
      copy:
        content: "{{ show_version.stdout[1] | default('') }}\n"
        dest: "./show_version_{{ inventory_hostname }}.txt"
      delegate_to: localhost

    - name: Debug show_version
      debug:
        var: show_version

- name: Parse collected outputs and generate reports on controller
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Ensure reports directory exists on controller
      file:
        path: /Users/jeremierouzet/Documents/Dev/ansible/jeysible_jeymacsrv01/infrahub_dynamic_inventory/inventory_output/cisco/common/report_ios_version
        state: directory
        mode: '0755'

    - name: Parse saved show_version files with PyATS parser
      shell: |
        {{ playbook_dir }}/../../../../bin/python {{ playbook_dir }}/../../../../scripts/parse_show_version_pyats.py ./show_version_{{ item.target_host }}.txt /Users/jeremierouzet/Documents/Dev/ansible/jeysible_jeymacsrv01/infrahub_dynamic_inventory/inventory_output/cisco/common/report_ios_version/show_version_{{ item.target_host }}
      register: parser_result
      changed_when: false
      loop: >-
        {{ (
            (hostvars['infrahub'].device_list2 | default([]))
            if (only_target is not defined)
            else (
              ((hostvars['infrahub'].device_list2 | selectattr('target_host','equalto', only_target) | list)
               + (hostvars['infrahub'].device_list2 | selectattr('Name','equalto', only_target) | list)
               + (hostvars['infrahub'].device_list2 | selectattr('IP','equalto', only_target) | list)) | unique
            )
          ) }}
      loop_control:
        label: "{{ item.Name }}"

    - name: Debug parser results
      debug:
        var: parser_result.results

    # Copy

    - name: Ensure output directory exists on controller
      file:
        path: /Users/jeremierouzet/Documents/Dev/ansible/jeysible_jeymacsrv01/infrahub_dynamic_inventory/inventory_output/cisco/common/report_ios_version
        state: directory
        mode: '0755'
      run_once: yes
      delegate_to: localhost

    - local_action:
        module: copy
        content: "{{ filtered_info_iosxe_version | to_nice_yaml }}"
        dest: /Users/jeremierouzet/Documents/Dev/ansible/jeysible_jeymacsrv01/infrahub_dynamic_inventory/inventory_output/cisco/common/report_ios_version/report_ios_version_device_name.yml
      when: filtered_info_iosxe_version is defined

    - local_action:
        module: copy
        content: "{{ filtered_info_iosxe_version | to_nice_json }}"
        dest: /Users/jeremierouzet/Documents/Dev/ansible/jeysible_jeymacsrv01/infrahub_dynamic_inventory/inventory_output/cisco/common/report_ios_version/report_ios_version_device_name.json
      when: filtered_info_iosxe_version is defined
