set version 20.3R1.8
{% for device_name in netbox_devices.json.results -%}
{% if device_name.name == 'jeyniper01' %}
set system host-name {{ device_name.name }}
set system root-authentication encrypted-password "$5$ub0EANni$ZZ8MSvNDdGJoDUjTf00q2wqTtZUqnzgo12u7wZrfg.4"
set system login user Jeyriku full-name Jeyriku
set system login user Jeyriku uid 100
set system login user Jeyriku class super-user
set system login user Jeyriku authentication encrypted-password "$5$nSRnDAuu$EhBK6nlwsvoDtHiGR9Ykh6w5RosnMIDsaGL5tj7K5z6"
set system services ssh root-login allow
set system services telnet
set system services xnm-clear-text
set system services netconf ssh
set system services rest https port 4443
set system services rest https addresses {{ device_name.primary_ip.address }}
set system services rest https server-certificate jeycert
set system services rest enable-explorer
set system auto-snapshot
set system domain-name {{ device_name.custom_fields.domain_name }}
set system domain-search {{ device_name.custom_fields.domain_name }}
set system time-zone Europe/Paris
set system name-server {{ device_name.custom_fields.dns_server_pri }}
set system name-server {{ device_name.custom_fields.dns_server_sec }}
set system syslog archive size 100k
set system syslog archive files 3
set system syslog user * any emergency
set system syslog file messages any critical
set system syslog file messages authorization info
set system syslog file interactive-commands interactive-commands error
set system syslog file kmd-logs daemon info
set system max-configurations-on-flash 5
set system max-configuration-rollbacks 5
set system license autoupdate url https://ae1.juniper.net/junos/key_retrieval
set system ntp server {{ device_name.custom_fields.dns_server_pri }}
set system ntp server {{ device_name.custom_fields.dns_server_sec }}
set security forwarding-options family mpls mode packet-based
{% endif %}
{% endfor %}
{% for data in netbox_ifaces.json.results if data.device.name == 'jeyniper01' -%}
{% if data.type.value == '1000base-t' %}
{% if data.enabled == true %}
set interfaces {{ data.name }} description {{ data.description }}
set interfaces {{ data.name}} flexible-vlan-tagging
set interfaces {{ data.name }} mtu {{ data.mtu }}
{% endif %}
{% endif %}
{% endfor %}
{% for ifdata in netbox_ipaddr.json.results -%}
{% if ifdata.custom_fields.iface_device == 'jeyniper01' %}
{% if ifdata.custom_fields.iface_role == 'mpls' -%}
set interfaces {{ ifdata.custom_fields.iface_parent }} unit {{ ifdata.custom_fields.iface_unit }} description {{ ifdata.description }}
set interfaces {{ ifdata.custom_fields.iface_parent }} unit {{ ifdata.custom_fields.iface_unit }} family inet address {{ ifdata.address }}
set interfaces {{ ifdata.custom_fields.iface_parent }} unit {{ ifdata.custom_fields.iface_unit }} family mpls
{% elif ifdata.custom_fields.iface_role == 'ip' -%}
set interfaces {{ ifdata.custom_fields.iface_parent }} unit {{ ifdata.custom_fields.iface_unit }} description {{ ifdata.description }}
set interfaces {{ ifdata.custom_fields.iface_parent }} unit {{ ifdata.custom_fields.iface_unit }} family inet address {{ ifdata.address }}
{% elif ifdata.custom_fields.iface_role == 'ipvrf' -%}
set interfaces {{ ifdata.custom_fields.iface_parent }} unit {{ ifdata.custom_fields.iface_unit }} description {{ ifdata.description }}
set interfaces {{ ifdata.custom_fields.iface_parent }} unit {{ ifdata.custom_fields.iface_unit }} family inet address {{ ifdata.address }}
{% endif %}
{% endif %}
{% endfor %}
{% for ifdata in netbox_ipaddr.json.results if ifdata.custom_fields.iface_unit|int > 0 -%}
set interfaces {{ ifdata.custom_fields.iface_parent  }} unit {{ ifdata.custom_fields.iface_unit }} vlan-id {{ ifdata.custom_fields.iface_unit }}
{% endfor %}
{% for device_name in netbox_devices.json.results -%}
{% if device_name.name == 'jeyniper01' %}
set snmp location {{ device_name.custom_fields.snmp_location }}
set snmp community {{ device_name.custom_fields.snmp_community }} authorization read-only
set snmp community {{ device_name.custom_fields.snmp_community }} {{ device_name.custom_fields.snmp_server }}/32
set snmp trap-options source-address {{ device_name.primary_ip.address }}
set forwarding-options packet-capture file filename testpacketcapture
set forwarding-options packet-capture maximum-capture-size 1500
set policy-options prefix-list Default 0.0.0.0/0
set policy-options policy-statement Export-static term 1 from protocol static
set policy-options policy-statement Export-static term 1 then accept
set policy-options policy-statement Vrf-Internet-Export term from-Vrf-Internet then community add Rt-Vpn-Internet
set policy-options policy-statement Vrf-Internet-Export term from-Vrf-Internet then accept
set policy-options policy-statement Vrf-Internet-Guest-Export term from-Vrf-Internet-Guest then community add Rt-Vpn-Internet-Guest
set policy-options policy-statement Vrf-Internet-Guest-Export term from-Vrf-Internet-Guest then accept
set policy-options policy-statement Vrf-Internet-Guest-Import term from-Vrf-Internet from community Rt-Vpn-Internet
set policy-options policy-statement Vrf-Internet-Guest-Import term from-Vrf-Internet from prefix-list Default
set policy-options policy-statement Vrf-Internet-Guest-Import term from-Vrf-Internet then accept
set policy-options policy-statement Vrf-Internet-Guest-Import term from-Vrf-Internet-Guest from community Rt-Vpn-Internet-Guest
set policy-options policy-statement Vrf-Internet-Guest-Import term from-Vrf-Internet-Guest then accept
set policy-options policy-statement Vrf-Internet-Import term from-Vrf-Internet from community Rt-Vpn-Internet
set policy-options policy-statement Vrf-Internet-Import term from-Vrf-Internet then accept
set policy-options community Rt-Vpn-Internet members target:65003:01
set policy-options community Rt-Vpn-Internet-Guest members target:65003:03
set firewall filter PCAP term 1 then sample
set firewall filter PCAP term 1 then accept
set firewall filter PCAP term allow-all-else then accept
{% endif %}
{% endfor %}
{% for vrf in netbox_vrfs.json.results if vrf.name == 'vpn-internet' %}
set routing-instances vpn-internet protocols bgp group external type external
set routing-instances vpn-internet protocols bgp group external family inet unicast
set routing-instances vpn-internet protocols bgp group external neighbor 192.168.13.2 peer-as 65002
{% endfor %}
{% for ifvrf in netbox_ifaces.json.results if ifvrf.device.name  == 'jeyniper01'-%}
{% if ifvrf.custom_fields.iface_vrf == 'vpn-internet' %}
set routing-instances vpn-internet interface {{ ifvrf.name }}
{% endif %}
{% endfor %}
{% for vrf in netbox_vrfs.json.results if vrf.name == 'vpn-internet' %}
set routing-instances vpn-internet description {{ vrf.name }}
set routing-instances vpn-internet instance-type vrf
set routing-instances vpn-internet routing-options autonomous-system 65003
{% endfor %}
{% for device_name in netbox_devices.json.results if device_name.name == 'jeyniper01' -%}
set routing-instances vpn-internet route-distinguisher {{ device_name.custom_fields.dev_lpbk }}:01
{% endfor %}
{% for vrf in netbox_vrfs.json.results if vrf.name == 'vpn-internet' %}
set routing-instances vpn-internet vrf-import Vrf-Internet-Import
set routing-instances vpn-internet vrf-export Vrf-Internet-Export
{% endfor %}
{% for vrf in netbox_vrfs.json.results if vrf.name == 'vpn-internet-guest' %}
set routing-instances vpn-internet description {{ vrf.name }}
set routing-instances vpn-internet-guest instance-type vrf
set routing-instances vpn-internet-guest routing-options static route 192.168.3.0/24 next-hop 192.168.30.2
{% endfor %}
{% for ifvrf in netbox_ifaces.json.results if ifvrf.device.name  == 'jeyniper01'-%}
{% if ifvrf.custom_fields.iface_vrf == 'vpn-internet-guest' %}
set routing-instances vpn-internet-guest interface {{ ifvrf.name }}
{% endif %}
{% endfor %}
{% for device_name in netbox_devices.json.results if device_name.name == 'jeyniper01' -%}
set routing-instances vpn-internet route-distinguisher {{ device_name.custom_fields.dev_lpbk }}:03
{% endfor %}
{% for vrf in netbox_vrfs.json.results if vrf.name == 'vpn-internet-guest' %}
set routing-instances vpn-internet-guest vrf-import Vrf-Internet-Guest-Import
set routing-instances vpn-internet-guest vrf-export Vrf-Internet-Guest-Export
{% endfor %}
{% for ospfdata in netbox_ipaddr.json.results if ospfdata.custom_fields.iface_device == 'jeyniper01'  -%}
{% if ospfdata.custom_fields.iface_role == 'mpls' %}
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} interface-type p2p
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} retransmit-interval 5
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} hello-interval 10
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} dead-interval 40
{% elif ospfdata.custom_fields.iface_role == 'iprr' -%}
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} interface-type p2p
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} retransmit-interval 5
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} hello-interval 10
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} dead-interval 40
{% elif ospfdata.custom_fields.iface_role == 'ip' -%}
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface {{ ospfdata.custom_fields.iface_parent }}.{{ ospfdata.custom_fields.iface_unit }} passive
{% endif %}
{% endfor %}
{% for ospfdata in netbox_ipaddr.json.results if ospfdata.custom_fields.iface_device == 'jeyniper01'  -%}
{% if ospfdata.custom_fields.iface_parent == 'loopback' %}
set protocols ospf area {{ospfdata.custom_fields.ospf_area}} interface lo0.0 passive
{% endif %}
{% endfor %}
set protocols ospf export Export-static
{% for device_name in netbox_devices.json.results if device_name.name == 'jeyniper01' -%}
set protocols bgp group route-reflector type internal
set protocols bgp group route-reflector local-address {{ device_name.custom_fields.dev_lpbk }}
set protocols bgp group route-reflector family inet unicast add-path receive
set protocols bgp group route-reflector family inet unicast add-path send path-count 6
set protocols bgp group route-reflector family inet-vpn unicast
set protocols bgp group route-reflector family route-target
{% endfor %}
{% for device_name in netbox_devices.json.results if device_name.name == 'jeyniper01' -%}
set protocols bgp group route-reflector neighbor {{ device_name.custom_fields.rr1 }}
set protocols bgp group route-reflector neighbor {{ device_name.custom_fields.rr2 }}
{% endfor %}
set protocols bgp traceoptions file bgp-log
set protocols bgp traceoptions file size 100k
set protocols bgp traceoptions file files 5
set protocols bgp traceoptions file world-readable
set protocols bgp traceoptions flag all send
set protocols bgp traceoptions flag all receive
set protocols bgp traceoptions flag all detail
deactivate protocols bgp traceoptions
{% for ldpdata in netbox_ipaddr.json.results if ldpdata.custom_fields.iface_device == 'jeyniper01'  -%}
{% if ldpdata.custom_fields.iface_role == 'mpls' %}
set protocols ldp interface {{ ldpdata.custom_fields.iface_parent }}.{{ ldpdata.custom_fields.iface_unit }}
{% endif %}
{% endfor %}
set protocols ldp igp-synchronization holddown-interval 15
{% for mplsdata in netbox_ipaddr.json.results if mplsdata.custom_fields.iface_device == 'jeyniper01'  -%}
{% if mplsdata.custom_fields.iface_role == 'mpls' %}
set protocols mpls interface {{ mplsdata.custom_fields.iface_parent }}.{{ mplsdata.custom_fields.iface_unit }}
{% endif %}
{% endfor %}
set protocols lldp interface all
{% for device_name in netbox_devices.json.results if device_name.name == 'jeyniper01' -%}
set routing-options rib inet.3 static route {{ device_name.custom_fields.rr1 }}/32 discard
set routing-options rib inet.3 static route {{ device_name.custom_fields.rr2 }}/32 discard
{% endfor %}
set routing-options static route 192.168.0.0/24 next-hop 192.168.16.2
set routing-options static route 192.168.4.0/24 next-hop 192.168.16.2
set routing-options static route 192.168.40.0/24 next-hop 192.168.16.2
{% for device_name in netbox_devices.json.results if device_name.name == 'jeyniper01' -%}
set routing-options route-distinguisher-id {{ device_name.custom_fields.dev_lpbk }}
set routing-options router-id {{ device_name.custom_fields.dev_lpbk }}
set routing-options autonomous-system {{ device_name.custom_fields.bgp_asn.asn }}
{% endfor %}
